<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Lima Rose Florería</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .admin-header {
            background: linear-gradient(135deg, #d63384, #e83e8c);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-header h1 {
            font-size: 24px;
            font-weight: 700;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .admin-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }

        .admin-tab.active {
            background: #d63384;
            color: white;
        }

        .admin-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #d63384;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input[type="file"] {
            border: 2px dashed #d63384;
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-group input[type="file"]:hover {
            background: #e9ecef;
            border-color: #b02a5b;
        }

        .file-upload-area {
            border: 2px dashed #d63384;
            background: #f8f9fa;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .file-upload-area:hover {
            background: #e9ecef;
            border-color: #b02a5b;
        }

        .file-upload-area.drag-over {
            background: #e3f2fd;
            border-color: #1976d2;
        }

        .upload-icon {
            font-size: 48px;
            color: #d63384;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #666;
            margin-bottom: 5px;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e8;
            border-radius: 8px;
            font-size: 14px;
            color: #2e7d32;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #d63384;
            color: white;
        }

        .btn-primary:hover {
            background: #b02a5b;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .products-list {
            display: grid;
            gap: 20px;
        }

        .product-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            border: 2px solid #eee;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .product-item:hover {
            border-color: #d63384;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-info {
            flex: 1;
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .product-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 16px;
            font-weight: 600;
            color: #d63384;
        }

        .product-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
            overflow: hidden;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .image-preview.empty {
            color: #999;
            flex-direction: column;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #d63384;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .product-item {
                flex-direction: column;
            }
            
            .product-actions {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="container">
            <h1><i class="fas fa-cog"></i> Panel de Administración</h1>
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Volver al sitio
            </a>
        </div>
    </header>

    <div class="admin-container">
        <div class="admin-tabs">
            <button class="admin-tab active" onclick="showSection('dashboard')">
                <i class="fas fa-chart-bar"></i> Dashboard
            </button>
            <button class="admin-tab" onclick="showSection('add-product')">
                <i class="fas fa-plus"></i> Agregar Producto
            </button>
            <button class="admin-tab" onclick="showSection('manage-products')">
                <i class="fas fa-box"></i> Gestionar Productos
            </button>
        </div>

        <div class="admin-content">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <h2>Resumen del Sistema</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-products">0</div>
                        <div class="stat-label">Total de Productos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-categories">0</div>
                        <div class="stat-label">Categorías</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="featured-products">0</div>
                        <div class="stat-label">Productos Destacados</div>
                    </div>
                </div>
            </div>

            <!-- Add Product Section -->
            <div id="add-product" class="section">
                <h2>Agregar Nuevo Producto</h2>
                <form id="product-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Producto</label>
                            <input type="text" name="name" required>
                        </div>
                        <div class="form-group">
                            <label>Precio (S/)</label>
                            <input type="number" name="price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>Categoría</label>
                            <select name="category" required>
                                <option value="">Seleccionar categoría</option>
                                <option value="ramos">Ramos</option>
                                <option value="mini ramos">Mini Ramos</option>
                                <option value="cajas">Cajas</option>
                                <option value="barriles">Barriles</option>
                                <option value="orquídeas">Orquídeas</option>
                                <option value="plantas">Plantas</option>
                                <option value="postres">Postres</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ocasión</label>
                            <select name="occasion">
                                <option value="">Seleccionar ocasión</option>
                                <option value="amor">Amor y Romance</option>
                                <option value="cumpleaños">Cumpleaños</option>
                                <option value="matrimonios">Matrimonios</option>
                                <option value="condolencias">Condolencias</option>
                                <option value="eventos">Eventos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Imagen del Producto</label>
                            <div class="file-upload-area" id="file-upload-area">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <div class="upload-text">Haz clic o arrastra una imagen aquí</div>
                                <small style="color: #666;">Formatos: JPG, PNG, WEBP (máx. 5MB)</small>
                                <input type="file" name="imageFile" accept="image/*" id="image-file-input" style="display: none;">
                            </div>
                            <div id="file-info" class="file-info" style="display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label>Precio Original (opcional)</label>
                            <input type="number" name="originalPrice" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Descuento (S/)</label>
                            <input type="number" name="discount" step="0.01" value="0">
                        </div>
                        <div class="form-group">
                            <label>Badge (opcional)</label>
                            <input type="text" name="badge" placeholder="NUEVO, OFERTA, etc.">
                        </div>
                        <div class="form-group full-width">
                            <label>Descripción</label>
                            <textarea name="description" rows="4"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label>Sección</label>
                            <select name="filter" required>
                                <option value="destacados">Destacados</option>
                                <option value="ofertas">Ofertas</option>
                                <option value="vendidos">Más Vendidos</option>
                                <option value="especiales">Especiales</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="image-preview empty" id="image-preview">
                        <i class="fas fa-image" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <span>Vista previa de imagen</span>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            Agregar Producto
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()" style="display: none;" id="cancel-edit-btn">
                            <i class="fas fa-times"></i>
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>

            <!-- Manage Products Section -->
            <div id="manage-products" class="section">
                <h2>Gestionar Productos</h2>
                <div class="products-list" id="products-list">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load products from the main script
        let adminProducts = {};
        
        // Initialize admin panel
        document.addEventListener('DOMContentLoaded', function() {
            loadProductsFromMainScript();
            updateDashboard();
            loadProductsList();
            
            setupFileUpload();
        });

        function setupFileUpload() {
            const fileInput = document.getElementById('image-file-input');
            const uploadArea = document.getElementById('file-upload-area');
            const fileInfo = document.getElementById('file-info');
            const preview = document.getElementById('image-preview');

            // Click to upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // File selection
            fileInput.addEventListener('change', handleFileSelect);

            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files: files } });
                }
            });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen válido.');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Máximo 5MB.');
                return;
            }

            // Show file info
            const fileInfo = document.getElementById('file-info');
            fileInfo.innerHTML = `
                <i class="fas fa-check-circle"></i>
                Archivo seleccionado: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
            `;
            fileInfo.style.display = 'block';

            // Convert to base64 and compress image
            const reader = new FileReader();
            reader.onload = function(e) {
                compressImage(e.target.result, (compressedBase64) => {
                    // Store compressed base64
                    const form = document.getElementById('product-form');
                    form.dataset.imageBase64 = compressedBase64;
                    
                    // Show preview
                    const preview = document.getElementById('image-preview');
                    preview.innerHTML = `<img src="${compressedBase64}" alt="Preview">`;
                    preview.classList.remove('empty');
                    
                    // Update file info with compression details
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    const compressedSize = ((compressedBase64.length * 0.75) / 1024 / 1024).toFixed(2);
                    
                    const fileInfo = document.getElementById('file-info');
                    fileInfo.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        ${file.name} - Original: ${originalSize}MB → Comprimida: ${compressedSize}MB
                    `;
                });
            };
            reader.readAsDataURL(file);
        }

        function compressImage(base64String, callback, quality = 0.8) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function() {
                // Calculate new dimensions (max 800px width)
                const maxWidth = 800;
                const maxHeight = 600;
                let { width, height } = img;

                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                if (height > maxHeight) {
                    width = (width * maxHeight) / height;
                    height = maxHeight;
                }

                canvas.width = width;
                canvas.height = height;

                // Draw and compress
                ctx.drawImage(img, 0, 0, width, height);
                const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                callback(compressedBase64);
            };

            img.src = base64String;
        }

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Reload products list if managing products
            if (sectionId === 'manage-products') {
                loadProductsList();
            }
        }

        function loadProductsFromMainScript() {
            // This simulates loading from the main script
            // In a real implementation, you'd load from localStorage or a database
            adminProducts = {
                destacados: JSON.parse(localStorage.getItem('products_destacados')) || [],
                ofertas: JSON.parse(localStorage.getItem('products_ofertas')) || [],
                vendidos: JSON.parse(localStorage.getItem('products_vendidos')) || [],
                especiales: JSON.parse(localStorage.getItem('products_especiales')) || []
            };
        }

        function saveProducts() {
            // Save to localStorage (in a real app, this would be a database)
            localStorage.setItem('products_destacados', JSON.stringify(adminProducts.destacados));
            localStorage.setItem('products_ofertas', JSON.stringify(adminProducts.ofertas));
            localStorage.setItem('products_vendidos', JSON.stringify(adminProducts.vendidos));
            localStorage.setItem('products_especiales', JSON.stringify(adminProducts.especiales));
        }

        function updateDashboard() {
            const totalProducts = Object.values(adminProducts).flat().length;
            const categories = [...new Set(Object.values(adminProducts).flat().map(p => p.category))];
            const featuredProducts = adminProducts.destacados?.length || 0;
            
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('total-categories').textContent = categories.length;
            document.getElementById('featured-products').textContent = featuredProducts;
        }

        function loadProductsList() {
            const container = document.getElementById('products-list');
            const allProducts = Object.values(adminProducts).flat();
            
            if (allProducts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>No hay productos registrados</h3>
                        <p>Agrega tu primer producto usando la pestaña "Agregar Producto"</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allProducts.map((product, index) => `
                <div class="product-item">
                    <div class="product-image">
                        <img src="${product.image}" alt="${product.name}">
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-details">
                            <strong>Categoría:</strong> ${product.category} | 
                            <strong>Ocasión:</strong> ${product.occasion || 'No especificada'}
                        </div>
                        <div class="product-price">S/ ${product.price.toFixed(2)}</div>
                    </div>
                    <div class="product-actions">
                        <button class="btn btn-secondary" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Product form submission
        document.getElementById('product-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const editId = this.dataset.editId;
            
            // Get image data (base64 from uploaded file)
            const imageBase64 = this.dataset.imageBase64;
            if (!imageBase64 && !editId) {
                alert('Por favor selecciona una imagen para el producto.');
                return;
            }

            const productData = {
                id: editId ? parseInt(editId) : Date.now(), // Use existing ID or generate new
                name: formData.get('name'),
                price: parseFloat(formData.get('price')),
                category: formData.get('category'),
                occasion: formData.get('occasion'),
                image: imageBase64, // Use base64 string instead of URL
                originalPrice: formData.get('originalPrice') ? parseFloat(formData.get('originalPrice')) : null,
                discount: parseFloat(formData.get('discount')) || 0,
                badge: formData.get('badge') || null,
                description: formData.get('description'),
                filter: formData.get('filter')
            };
            
            // If editing and no new image uploaded, keep the existing image
            if (editId && !imageBase64) {
                const existingProduct = Object.values(adminProducts).flat().find(p => p.id === parseInt(editId));
                if (existingProduct) {
                    productData.image = existingProduct.image;
                }
            }
            
            if (editId) {
                // Edit mode: remove old product and add updated one
                Object.keys(adminProducts).forEach(category => {
                    adminProducts[category] = adminProducts[category].filter(p => p.id !== parseInt(editId));
                });
                
                // Add updated product to appropriate category
                if (!adminProducts[productData.filter]) {
                    adminProducts[productData.filter] = [];
                }
                adminProducts[productData.filter].push(productData);
                
                alert('Producto actualizado exitosamente!');
            } else {
                // Add mode: add new product
                if (!adminProducts[productData.filter]) {
                    adminProducts[productData.filter] = [];
                }
                adminProducts[productData.filter].push(productData);
                
                alert('Producto agregado exitosamente!');
            }
            
            // Save and update
            saveProducts();
            updateDashboard();
            loadProductsList();
            
            // Reset form
            resetForm();
        });

        function resetForm() {
            const form = document.getElementById('product-form');
            form.reset();
            delete form.dataset.editId;
            delete form.dataset.imageBase64;
            form.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-plus"></i> Agregar Producto';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            
            // Reset image preview
            document.getElementById('image-preview').innerHTML = `
                <i class="fas fa-image" style="font-size: 48px; margin-bottom: 10px;"></i>
                <span>Vista previa de imagen</span>
            `;
            document.getElementById('image-preview').classList.add('empty');
            
            // Reset file info
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('file-info').innerHTML = '';
            
            // Reset file input
            document.getElementById('image-file-input').value = '';
        }

        function deleteProduct(productId) {
            if (confirm('¿Estás seguro de que deseas eliminar este producto?')) {
                // Find and remove product from all categories
                Object.keys(adminProducts).forEach(category => {
                    adminProducts[category] = adminProducts[category].filter(p => p.id !== productId);
                });
                
                saveProducts();
                updateDashboard();
                loadProductsList();
                
                alert('Producto eliminado exitosamente!');
            }
        }

        function editProduct(productId) {
            // Find the product
            let product = null;
            Object.values(adminProducts).flat().forEach(p => {
                if (p.id === productId) product = p;
            });
            
            if (product) {
                // Switch to add product tab and populate form
                showSection('add-product');
                document.querySelector('.admin-tab[onclick="showSection(\'add-product\')"]').click();
                
                // Populate form
                document.querySelector('input[name="name"]').value = product.name;
                document.querySelector('input[name="price"]').value = product.price;
                document.querySelector('select[name="category"]').value = product.category;
                document.querySelector('select[name="occasion"]').value = product.occasion || '';
                document.querySelector('input[name="originalPrice"]').value = product.originalPrice || '';
                document.querySelector('input[name="discount"]').value = product.discount;
                document.querySelector('input[name="badge"]').value = product.badge || '';
                document.querySelector('textarea[name="description"]').value = product.description || '';
                document.querySelector('select[name="filter"]').value = product.filter || 'destacados';
                
                // Set image data and preview
                const editForm = document.getElementById('product-form');
                editForm.dataset.imageBase64 = product.image;
                
                const preview = document.getElementById('image-preview');
                preview.innerHTML = `<img src="${product.image}" alt="Preview">`;
                preview.classList.remove('empty');
                
                // Update file info
                const fileInfo = document.getElementById('file-info');
                fileInfo.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    Imagen cargada (editando producto existente)
                `;
                fileInfo.style.display = 'block';
                
                // Change form behavior to edit mode
                editForm.dataset.editId = productId;
                editForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
                document.getElementById('cancel-edit-btn').style.display = 'inline-flex';
            }
        }
    </script>
</body>
</html>